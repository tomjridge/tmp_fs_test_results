# tesing pwrite and write


##############################################
# initialization
##############################################

# empty and non-empty directories to write to
mkdir /empty_dir 0o777
Tau
None1

mkdir /non_empty_dir 0o777
Tau
None1


chdir /non_empty_dir
Tau
None1



##############################################
# simple writes
##############################################

# start on empty file and write something
open f1.txt [O_RDWR;O_CREAT] 0o666
Tau
Int1(3)

write (FD 3) "0123456789" 10
Tau
Int1(10)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("0123456789")

close (FD 3)
Tau
None1


# write even more stuff at the end
open f1.txt [O_RDWR;O_APPEND] 0o666
Tau
Int1(3)

write (FD 3) "0123456789" 10
Tau
Int1(10)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("01234567890123456789")

close (FD 3)
Tau
None1


# overwrite at begining
open f1.txt [O_RDWR] 0o666
Tau
Int1(3)

write (FD 3) "XXX" 3
Tau
Int1(3)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("XXX34567890123456789")

close (FD 3)
Tau
None1


# truncate file
open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

write (FD 3) "0123456789" 10
Tau
Int1(10)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("0123456789")

close (FD 3)
Tau
None1


# shorter size
open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

write (FD 3) "0123456789" 5
Tau
Int1(5)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("01234")

close (FD 3)
Tau
None1



##############################################
# pwrite
##############################################

# write with pwrite at arbitrary positions
open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

write (FD 3) "0123456789" 10
Tau
Int1(10)

pwrite (FD 3) "X" 1 4
Tau
Int1(1)

pwrite (FD 3) "X" 1 6
Tau
Int1(1)

pwrite (FD 3) "X" 1 8
Tau
Int1(1)

write (FD 3) "0123456789" 10
Tau
Int1(10)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("0123X5X7X90123456789")

close (FD 3)
Tau
None1



# pwrite with negative index
open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

pwrite (FD 3) "XXX" 3 -100
Tau
EINVAL

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("")

close (FD 3)
Tau
None1



# pwrite after end of file
open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

pwrite (FD 3) "XXX" 3 10
Tau
Int1(3)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("\000\000\000\000\000\000\000\000\000\000XXX")

close (FD 3)
Tau
None1



# pwrite then write
open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

pwrite (FD 3) "XXX" 3 10
Tau
Int1(3)

write (FD 3) "01234" 5
Tau
Int1(5)

close (FD 3)
Tau
None1


open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("01234\000\000\000\000\000XXX")

close (FD 3)
Tau
None1




##############################################
# lseek 
##############################################

open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

write (FD 3) "0123456789" 10
Tau
Int1(10)

lseek (FD 3) -3 SEEK_CUR
Tau
Int1(7)

write (FD 3) "ABC" 3
Tau
Int1(3)

pwrite (FD 3) "X" 1 4
Tau
Int1(1)

lseek (FD 3) 2 SEEK_SET
Tau
Int1(2)

write (FD 3) "Y" 1
Tau
Int1(1)

lseek (FD 3) 0 SEEK_SET
Tau
Int1(0)

read (FD 3) 100
Tau
Bytes1("01Y3X56ABC")

close (FD 3)
Tau
None1


#write after end adds 0s
open f1.txt [O_RDWR;O_TRUNC] 0o666
Tau
Int1(3)

write (FD 3) "0123456789" 10
Tau
Int1(10)

lseek (FD 3) 5 SEEK_CUR
Tau
Int1(15)

write (FD 3) "ABCDE" 5
Tau
Int1(5)

lseek (FD 3) 0 SEEK_SET
Tau
Int1(0)

read (FD 3) 100
Tau
Bytes1("0123456789\000\000\000\000\000ABCDE")

close (FD 3)
Tau
None1


##############################################
# writes with different file-descriptors
##############################################

# read/write is fine
open f1.txt [O_RDWR;O_TRUNC]
Tau
Int1(3)

write (FD 3) "0123456789" 10
Tau
Int1(10)

lseek (FD 3) 0 SEEK_SET
Tau
Int1(0)

read (FD 3) 100
Tau
Bytes1("0123456789")

close (FD 3)
Tau
None1


# write_only is fine / truncate works
open f1.txt [O_WRONLY;O_TRUNC]
Tau
Int1(3)

write (FD 3) "ABCDE" 5
Tau
Int1(5)

close (FD 3)
Tau
None1

open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("ABCDE")

close (FD 3)
Tau
None1


# write_only without truncate keeps old content, but overwrites it 
open f1.txt [O_WRONLY]
Tau
Int1(3)

write (FD 3) "012" 3
Tau
Int1(3)

lseek (FD 3) 0 SEEK_SET
Tau
Int1(0)

read (FD 3) 100
Tau
EBADF

close (FD 3)
Tau
None1

open f1.txt [O_RDONLY]
Tau
Int1(3)

read (FD 3) 100
Tau
Bytes1("012DE")

close (FD 3)
Tau
None1


# append is adding at end
open f1.txt [O_RDWR;O_APPEND]
Tau
Int1(3)

write (FD 3) "ABCDE" 5
Tau
Int1(5)

lseek (FD 3) 0 SEEK_SET
Tau
Int1(0)

read (FD 3) 100
Tau
Bytes1("012DEABCDE")

close (FD 3)
Tau
None1


# writing a read-only file fails
open f1.txt [O_RDONLY]
Tau
Int1(3)

write (FD 3) "ABCDE" 5
Tau
EBADF

lseek (FD 3) 0 SEEK_SET
Tau
Int1(0)

read (FD 3) 100
Tau
Bytes1("012DEABCDE")

close (FD 3)
Tau
None1


# closed FD cannot be written to
write (FD 3) "ABCDE" 5
Tau
EBADF


# non existing FD can't be used
write (FD 300) "ABCDE" 5
Tau
EBADF



##############################################
# writing to directories
# this is already prohibited 
# by the open command
##############################################

open /non_empty_dir [O_RDWR]
Tau
EISDIR

write (FD 3) "ABC" 3
Tau
EBADF

close (FD 3)
Tau
EBADF


open /non_empty_dir [O_WRONLY]
Tau
EISDIR

write (FD 3) "ABC" 3
Tau
EBADF

close (FD 3)
Tau
EBADF


open /non_empty_dir [O_RDONLY]
Tau
Int1(3)

write (FD 3) "ABC" 3
Tau
EBADF

close (FD 3)
Tau
None1

