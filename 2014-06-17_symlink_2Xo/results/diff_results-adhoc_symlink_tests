        # adhoc_link_tests

        # initialization

     4: mkdir /dir_1 0o777
        Tau
        RV_none

     5: mkdir /dir_1/dir_11 0o777
        Tau
        RV_none

     6: mkdir /dir_2 0o777
        Tau
        RV_none


     8: open /dir_1/f1.txt [O_RDWR;O_CREAT] 0o666
        Tau
        RV_num(3)

     9: write (FD 3) "content of /dir_1/f1.txt" 24
        Tau
        RV_num(24)

    10: close (FD 3)
        Tau
        RV_none


    12: open /dir_1/f2.txt [O_RDWR;O_CREAT] 0o666
        Tau
        RV_num(3)

    13: write (FD 3) "content of /dir_1/f2.txt" 24
        Tau
        RV_num(24)

    14: close (FD 3)
        Tau
        RV_none


    16: open /dir_2/f1.txt [O_RDWR;O_CREAT] 0o666
        Tau
        RV_num(3)

    17: write (FD 3) "content of /dir_2/f1.txt" 24
        Tau
        RV_num(24)

    18: close (FD 3)
        Tau
        RV_none



        ###################################################
        # simple tests, that mimic common use-cases
        ###################################################

        # create a symlink to an existing file an read the file
        # through the symlink

    28: symlink /dir_1/f1.txt /symlink_1
        Tau
        RV_none

    29: open /symlink_1 [O_RDONLY]
        Tau
        RV_num(3)

    30: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    31: close (FD 3)
        Tau
        RV_none


        # try two indirections
    34: symlink /symlink_1 /symlink_2
        Tau
        RV_none

    35: open /symlink_2 [O_RDONLY]
        Tau
        RV_num(3)

    36: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    37: close (FD 3)
        Tau
        RV_none


        # remove symlink 1 and read symlink 2
    40: unlink /symlink_1
        Tau
        RV_none

    41: open /symlink_2 [O_RDONLY]
        Tau
        ENOENT

    42: pread (FD 3) 1000 0
        Tau
        EBADF

    43: close (FD 3)
        Tau
        EBADF


        # now try symbolic links to a directory
    46: symlink /dir_1 /symlink_1
        Tau
        RV_none


    48: open /symlink_1/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    49: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    50: close (FD 3)
        Tau
        RV_none


    52: open /symlink_2/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    53: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    54: close (FD 3)
        Tau
        RV_none


        # renaming of symbolic links renames links not pointed to files
    57: rename /symlink_2 /symlink_2b
        Tau
        RV_none

    58: open /symlink_2b/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    59: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    60: close (FD 3)
        Tau
        RV_none


    62: open /dir_1/f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    63: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f1.txt")

    64: close (FD 3)
        Tau
        RV_none


    66: open /symlink_2/f1.txt [O_RDONLY]
        Tau
        ENOENT

    67: pread (FD 3) 1000 0
        Tau
        EBADF

    68: close (FD 3)
        Tau
        EBADF



        # try relative symbolic links
    72: symlink f2.txt /dir_1/symlink_f2.txt
        Tau
        RV_none

    73: open /dir_1/symlink_f2.txt [O_RDONLY]
        Tau
        RV_num(3)

    74: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_1/f2.txt")

    75: close (FD 3)
        Tau
        RV_none


    77: symlink ../dir_2/f1.txt /dir_1/symlink_d2_f1.txt
        Tau
        RV_none

    78: open /dir_1/symlink_d2_f1.txt [O_RDONLY]
        Tau
        RV_num(3)

    79: pread (FD 3) 1000 0
        Tau
        RV_bytes("content of /dir_2/f1.txt")

    80: close (FD 3)
        Tau
        RV_none


        # read the content of symbolic links
    83: readlink /symlink_1
        Tau
        RV_bytes("/dir_1")

    84: readlink /symlink_1/
        Tau
        EINVAL

    85: readlink /no_such_link
        Tau
        ENOENT

    86: readlink /symlink_1b
        Tau
        ENOENT

    87: readlink /symlink_1b/
        Tau
        ENOENT

    88: readlink /dir_1/symlink_f2.txt
        Tau
        RV_bytes("f2.txt")

    89: readlink /dir_1/symlink_d2_f1.txt
        Tau
        RV_bytes("../dir_2/f1.txt")


        # cleanup
    92: unlink /symlink_1
        Tau
        RV_none

    93: unlink /symlink_2b
        Tau
        RV_none

    94: unlink /dir_1/symlink_f2.txt
        Tau
        RV_none

    95: unlink /dir_1/symlink_d2_f1.txt
        Tau
        RV_none



        ###################################################
        # testing for corners
        ###################################################

        # linking to non-existing dirs is OK
   103: symlink /no_such_dir/ /slink_no_such1
        Tau
        RV_none

   104: symlink /no_such_file /slink_no_such2
        Tau
        RV_none

   105: chdir /slink_no_such1
        Tau
        ENOENT

   106: unlink /slink_no_such1
        Tau
        RV_none

   107: unlink /slink_no_such2
        Tau
        RV_none


        # existing files and dirs canot be overriden by symlink
   110: symlink /dir_1 /dir_2
        Tau
        EEXIST

   111: symlink /dir_1 /dir_1/f1.txt
        Tau
        EEXIST

   112: symlink /dir_1 /dir_1/symlink.txt
        Tau
        RV_none

   113: symlink /dir_2 /dir_1/symlink.txt
        Tau
        EEXIST

   114: unlink /dir_1/symlink.txt
        Tau
        RV_none


        # the new link name must not end with a slash
   117: symlink xyz /slink_1
        Tau
        RV_none

   118: symlink xyz /slink_2/
        Tau
        ENOENT

   119: unlink /slink_1
        Tau
        RV_none


        # cyclic links can be created, but raise ELOOP when followed
   122: symlink /cyclic_link1 /cyclic_link2
        Tau
        RV_none

   123: symlink /cyclic_link2 /cyclic_link1
        Tau
        RV_none

   124: chdir /cyclic_link1
        Tau
        ELOOP

   125: unlink /cyclic_link1
        Tau
        RV_none

   126: unlink /cyclic_link2
        Tau
        RV_none


        # playing around with trailing slashes
   129: symlink /dir_1/f1.txt /filelink
        Tau
        RV_none

   130: symlink /dir_1 /dirlink
        Tau
        RV_none


   132: open_close /filelink [O_RDONLY]
        Tau
        RV_none

   133: open_close /filelink [O_RDONLY]
        Tau
        RV_none


   135: chdir /dirlink
        Tau
        RV_none

   136: chdir /dirlink/
        Tau
        RV_none

   137: open_close f1.txt [O_RDONLY]
        Tau
        RV_none

   138: unlink /dirlink
        Tau
        RV_none

   139: unlink /filelink
        Tau
        RV_none

   140: chdir /
        Tau
        RV_none


        # follow a symlink to a dir and then go to parent dir
   143: symlink /dir_1/dir_11 /dirlink
        Tau
        RV_none

   144: chdir /dirlink
        Tau
        RV_none

   145: chdir ..
        Tau
        RV_none

        # we should be in /dir_1 now, not /, so we can read f1.txt
   147: open_close f1.txt [O_RDONLY]
        Tau
        RV_none

   148: open_close dir_1/f1.txt [O_RDONLY]
        Tau
        ENOENT

   149: unlink /dirlink
        Tau
        RV_none



        ###################################################
        # whether a symbolic link that occurs as the last
        # component of a resolved path is followed depends
        # on the command, so test it for all commands
        ###################################################

   158: symlink /dir_1 /dir_link
        Tau
        RV_none

   159: symlink /dir_1/f1.txt /file_link
        Tau
        RV_none


   161: link /dir_1 /dir_3
        Tau
        EPERM

   162: link /dir_link /dir_4
        Tau
        RV_none

   163: link /dir_1/f1.txt /f1.txt
        Tau
        RV_none

   164: link /file_link /f2.txt
        Tau
        RV_none


   166: mkdir /dir_link 0o777
        Tau
        EEXIST

   167: mkdir /file_link 0o777
        Tau
        EEXIST

   168: mkdir /dir_1 0o777
        Tau
        EEXIST

   169: mkdir /dir_1/f1.txt 0o777
        Tau
        EEXIST


   171: symlink /dir_5 /new_dir_link
        Tau
        RV_none

   172: mkdir /new_dir_link 0o777
        Tau
        EEXIST


   174: symlink /f_5 /new_file_link_1
        Tau
        RV_none

   175: symlink /f_6 /new_file_link_2
        Tau
        RV_none

   176: open_close /new_file_link_1 [O_RDWR;O_CREAT] 0o666
        Tau
        RV_none

   177: symlink xyz /new_file_link_2
        Tau
        EEXIST


   179: stat /dir_link
        Tau
        { st_dev=2049; st_ino=1048800; st_kind=S_IFDIR; st_perm=0o755; st_nlink=3; st_uid=0; st_gid=0; st_rdev=0; st_size=4096; }

   180: stat /file_link
        Tau
        { st_dev=2049; st_ino=1048803; st_kind=S_IFREG; st_perm=0o644; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=24; }


   182: truncate /file_link 0
        Tau
        RV_none

   183: stat /file_link
        Tau
        { st_dev=2049; st_ino=1048803; st_kind=S_IFREG; st_perm=0o644; st_nlink=2; st_uid=0; st_gid=0; st_rdev=0; st_size=0; }



trace accepted
